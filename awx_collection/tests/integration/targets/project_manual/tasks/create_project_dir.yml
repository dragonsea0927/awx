---
- name: Load the UI settings
  set_fact:
    project_base_dir: "{{ controller_settings.project_base_dir }}"
    inv_name: "AWX-Collection-tests-manual_project-inv-{{ test_id }}"
    host_name: "AWX-Collection-tests-manual_project-host-{{ test_id }}"
    cred_name: "AWX-Collection-tests-manual_project-cred-{{ test_id }}"
  vars:
    controller_settings: "{{ lookup('awx.awx.controller_api', 'config/') }}"

- inventory:
    name: "{{ inv_name }}"
    organization: Default

- host:
    name: "{{ host_name }}"
    inventory: "{{ inv_name }}"
    variables:
      ansible_connection: local

- name: Create an unused SSH / Machine credential
  credential:
    name: "{{ cred_name }}"
    credential_type: Machine
    inputs:
      ssh_key_data: |
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEIIUl6R1xgzR6siIUArz4XBPtGZ09aetma2eWf1v3uYymoAoGCCqGSM49
        AwEHoUQDQgAENJNjgeZDAh/+BY860s0yqrLDprXJflY0GvHIr7lX3ieCtrzOMCVU
        QWzw35pc5tvuP34SSi0ZE1E+7cVMDDOF3w==
        -----END EC PRIVATE KEY-----
    organization: Default

- block:
    - name: Add a path to a setting
      settings:
        name: AWX_ISOLATION_SHOW_PATHS
        value: "[{{ project_base_dir }}]"

    - name: Create a directory for manual project
      ad_hoc_command:
        credential: "{{ cred_name }}"
        inventory: "{{ inv_name }}"
        job_type: run
        module_args: "mkdir -p {{ project_base_dir }}/{{ project_dir_name }}"
        module_name: command
        wait: true

  always:
    - name: Delete path from setting
      settings:
        name: AWX_ISOLATION_SHOW_PATHS
        value: []

    - name: Delete dummy credential
      credential:
        name: "{{ cred_name }}"
        credential_type: Machine
        state: absent

    - name: Delete host
      host:
        name: "{{ host_name }}"
        inventory: "{{ inv_name }}"
        state: absent

    - name: Delete Inventory
      inventory:
        name: "{{ inv_name }}"
        organization: Default
        state: absent
