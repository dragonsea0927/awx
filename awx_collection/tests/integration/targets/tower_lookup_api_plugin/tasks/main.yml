---
- name: Generate a random string for test
  set_fact:
    test_id: "{{ lookup('password', '/dev/null chars=ascii_letters length=16') }}"
  when: test_id is not defined

- name: Generate usernames
  set_fact:
    usernames:
      - "AWX-Collection-tests-tower_api_lookup-user1-{{ test_id }}"
      - "AWX-Collection-tests-tower_api_lookup-user2-{{ test_id }}"
      - "AWX-Collection-tests-tower_api_lookup-user3-{{ test_id }}"

- name: Create all of our users
  tower_user:
    username: "{{ item }}"
    is_superuser: true
    password: "{{ test_id }}"
  loop: "{{ usernames }}"
  register: user_creation_results

- tower_meta:
  register: tower_meta

- block:
    - name: Test too many params (failure from validation of terms)
      set_fact:
        junk: "{{ query(tower_meta.prefix + '.tower_api', 'users', 'teams', query_params={}, ) }}"
      ignore_errors: true
      register: result

    - assert:
        that:
          - result is failed
          - "'You must pass exactly one endpoint to query' in result.msg"

    - name: Try to load invalid endpoint
      set_fact:
        junk: "{{ query(tower_meta.prefix + '.tower_api', 'john', query_params={}, ) }}"
      ignore_errors: true
      register: result

    - assert:
        that:
          - result is failed
          - "'The requested object could not be found at' in result.msg"

    - name: Load user of a specific name without promoting objects
      set_fact:
        users: "{{ lookup(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }, return_objects=False) }}"

    - assert:
        that:
          - users['results'] | length() == 1
          - users['count'] == 1
          - users['results'][0]['id'] == user_creation_results['results'][0]['id']

    - name: Loop over one user with the loop syntax
      assert:
        that:
          - item['id'] == user_creation_results['results'][0]['id']
      loop: "{{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }) }}"
      loop_control:
        label: "{{ item['id'] }}"

    - name: Get a page of users as just ids
      set_fact:
        users: "{{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username__endswith': test_id, 'page_size': 2 }, return_ids=True ) }}"

    - name: Assert that user list has 2 integer ids only
      assert:
        that:
          - users | length() == 2
          - user_creation_results['results'][0]['id'] in users

    - name: Get all users of a system through next attribute
      set_fact:
        users: "{{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username__endswith': test_id, 'page_size': 1 }, return_all=true ) }}"

    - assert:
        that:
          - users | length() >= 3

    - name: Get the ID of the first user created and verify that it is correct
      assert:
        that: "{{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }, return_ids=True) }}[0] == {{ user_creation_results['results'][0]['id'] }}"

    - name: Try to get an ID of someone who does not exist
      set_fact:
        failed_user_id: "{{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username': 'john jacob jingleheimer schmidt' }, expect_one=True) }}"
      register: result
      ignore_errors: true

    - assert:
        that:
          - result is failed
          - "'Expected one object from endpoint users' in result['msg']"

    - name: Lookup too many users
      set_fact:
        too_many_user_ids: " {{ query(tower_meta.prefix + '.tower_api', 'users', query_params={ 'username__endswith': test_id }, expect_one=True) }}"
      register: results
      ignore_errors: true

    - assert:
        that:
          - results is failed
          - "'Expected one object from endpoint users, but obtained 3' in results['msg']"

    - name: Get the settings page
      assert:
        that:
          - "'CUSTOM_LOGO' in {{ lookup(tower_meta.prefix + '.tower_api', 'settings/ui' ) }}"

    - name: Get the ping page
      set_fact:
        ping_data: "{{ lookup(tower_meta.prefix + '.tower_api', 'ping' ) }}"
      register: results

    - assert:
        that:
          - results is succeeded
          - "'active_node' in ping_data"

  always:
    - name: Cleanup users
      tower_user:
        username: "{{ item }}"
        state: absent
      loop: "{{ usernames }}"
