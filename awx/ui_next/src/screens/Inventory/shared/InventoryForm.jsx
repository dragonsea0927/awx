import React from 'react';
import { Formik, Field } from 'formik';
import { withI18n } from '@lingui/react';
import { t } from '@lingui/macro';
import { func, number, shape } from 'prop-types';

import { VariablesField } from '@components/CodeMirrorInput';
import { Form } from '@patternfly/react-core';
import FormField, { FormSubmitError } from '@components/FormField';
import FormActionGroup from '@components/FormActionGroup/FormActionGroup';
import FormRow from '@components/FormRow';
import { required } from '@util/validators';
import InstanceGroupsLookup from '@components/Lookup/InstanceGroupsLookup';
import OrganizationLookup from '@components/Lookup/OrganizationLookup';
import CredentialLookup from '@components/Lookup/CredentialLookup';

function InventoryForm({
  inventory = {},
  i18n,
  onCancel,
  onSubmit,
  instanceGroups,
  credentialTypeId,
  submitError,
}) {
  const initialValues = {
    name: inventory.name || '',
    description: inventory.description || '',
    variables: inventory.variables || '---',
    organization:
      (inventory.summary_fields && inventory.summary_fields.organization) ||
      null,
    instanceGroups: instanceGroups || [],
    insights_credential:
      (inventory.summary_fields &&
        inventory.summary_fields.insights_credential) ||
      null,
  };
  return (
    <Formik
      initialValues={initialValues}
      onSubmit={values => {
        onSubmit(values);
      }}
    >
      {formik => (
        <Form autoComplete="off" onSubmit={formik.handleSubmit}>
          <FormRow>
            <FormField
              id="inventory-name"
              label={i18n._(t`Name`)}
              name="name"
              type="text"
              validate={required(null, i18n)}
              isRequired
            />
            <FormField
              id="inventory-description"
              label={i18n._(t`Description`)}
              name="description"
              type="text"
            />
            <Field
              id="inventory-organization"
              label={i18n._(t`Organization`)}
              name="organization"
              validate={required(
                i18n._(t`Select a value for this field`),
                i18n
              )}
            >
              {({ form, field }) => (
                <OrganizationLookup
                  helperTextInvalid={form.errors.organization}
                  isValid={
                    !form.touched.organization || !form.errors.organization
                  }
                  onBlur={() => form.setFieldTouched('organization')}
                  onChange={value => {
                    form.setFieldValue('organization', value);
                  }}
                  value={field.value}
                  touched={form.touched.organization}
                  error={form.errors.organization}
                  required
                />
              )}
            </Field>
            <Field
              id="inventory-insights_credential"
              label={i18n._(t`Insights Credential`)}
              name="insights_credential"
            >
              {({ field, form }) => (
                <CredentialLookup
                  label={i18n._(t`Insights Credential`)}
                  credentialTypeId={credentialTypeId}
                  onChange={value =>
                    form.setFieldValue('insights_credential', value)
                  }
                  value={field.value}
                />
              )}
            </Field>
          </FormRow>
          <FormRow>
            <Field
              id="inventory-instanceGroups"
              label={i18n._(t`Instance Groups`)}
              name="instanceGroups"
            >
              {({ field, form }) => (
                <InstanceGroupsLookup
                  value={field.value}
                  onChange={value => {
                    form.setFieldValue('instanceGroups', value);
                  }}
                />
              )}
            </Field>
          </FormRow>
          <FormRow>
            <VariablesField
              tooltip={i18n._(
                t`Enter inventory variables using either JSON or YAML syntax. Use the radio button to toggle between the two. Refer to the Ansible Tower documentation for example syntax`
              )}
              id="inventory-variables"
              name="variables"
              label={i18n._(t`Variables`)}
            />
          </FormRow>
          <FormRow>
            <FormSubmitError error={submitError} />
            <FormActionGroup
              onCancel={onCancel}
              onSubmit={formik.handleSubmit}
            />
          </FormRow>
        </Form>
      )}
    </Formik>
  );
}

InventoryForm.proptype = {
  handleSubmit: func.isRequired,
  handleCancel: func.isRequired,
  instanceGroups: shape(),
  inventory: shape(),
  credentialTypeId: number.isRequired,
  submitError: shape(),
};

InventoryForm.defaultProps = {
  inventory: {},
  instanceGroups: [],
  submitError: null,
};

export default withI18n()(InventoryForm);
